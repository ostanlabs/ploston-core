# =============================================================================
# Trigger Downstream Builds
# =============================================================================
# When ploston-core CI passes on main, trigger ploston to rebuild its RC image
# with the new core version. This ensures changes to ploston-core are tested
# in the full system E2E tests.
#
# Flow:
#   1. Push to ploston-core/main triggers CI
#   2. CI passes â†’ this workflow runs
#   3. Triggers ploston's build-rc workflow with core_sha parameter
#   4. ploston builds RC image with the new ploston-core version
#   5. Meta-repo runs E2E tests against the RC
# =============================================================================

name: Trigger Downstream

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  trigger-ploston-rebuild:
    name: Trigger Ploston RC Build
    runs-on: ubuntu-latest
    # Only run if CI succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Trigger ploston build-rc workflow
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PLOSTON_REPO_TOKEN }}
          repository: ostanlabs/ploston
          event-type: core-updated
          client-payload: |
            {
              "core_sha": "${{ github.event.workflow_run.head_sha }}",
              "core_short_sha": "${{ github.event.workflow_run.head_sha }}",
              "triggered_by": "ploston-core",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"
            }

      - name: Summary
        run: |
          echo "## Downstream Build Triggered ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered ploston to rebuild RC image with:" >> $GITHUB_STEP_SUMMARY
          echo "- **ploston-core SHA:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This will:" >> $GITHUB_STEP_SUMMARY
          echo "1. Build \`ploston:rc-<sha>\` image with new ploston-core" >> $GITHUB_STEP_SUMMARY
          echo "2. Trigger meta-repo E2E tests" >> $GITHUB_STEP_SUMMARY
          echo "3. Promote to stable if tests pass" >> $GITHUB_STEP_SUMMARY

