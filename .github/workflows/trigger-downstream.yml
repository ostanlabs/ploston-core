# =============================================================================
# Trigger Downstream Builds (Hub-and-Spoke Model)
# =============================================================================
# When ploston-core CI passes on main, trigger the meta-repo to rebuild ALL
# dependent packages. The meta-repo handles the full CI pipeline.
#
# Flow:
#   1. Push to ploston-core/main triggers CI
#   2. CI passes â†’ this workflow runs
#   3. Triggers meta-repo with core-updated event
#   4. Meta-repo rebuilds ALL 4 dependents (ploston, enterprise, cli, runner)
#   5. Meta-repo runs integration tests with all artifacts
# =============================================================================

name: Trigger Downstream

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]

jobs:
  trigger-meta-repo:
    name: Trigger Meta-Repo CI
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Trigger meta-repo to rebuild ALL dependents
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.META_REPO_TOKEN }}
          repository: ostanlabs/agent-execution-layer
          event-type: core-updated
          client-payload: |
            {
              "trigger_repo": "ploston-core",
              "trigger_sha": "${{ github.event.workflow_run.head_sha }}"
            }

      - name: Summary
        run: |
          echo "## Meta-Repo CI Triggered ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered meta-repo to rebuild ALL dependents with:" >> $GITHUB_STEP_SUMMARY
          echo "- **ploston-core SHA:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What happens next:" >> $GITHUB_STEP_SUMMARY
          echo "1. Meta-repo rebuilds: ploston, ploston-enterprise, ploston-cli, ploston-runner" >> $GITHUB_STEP_SUMMARY
          echo "2. Runs integration tests (Docker Compose + K8s)" >> $GITHUB_STEP_SUMMARY
          echo "3. Promotes images to :edge on success" >> $GITHUB_STEP_SUMMARY
          echo "4. Updates dashboard" >> $GITHUB_STEP_SUMMARY
